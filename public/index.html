<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Downloader 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 450px; text-align: center; }
        h2 { margin: 0 0 20px; color: #333; }
        .input-box { position: relative; margin-bottom: 20px; }
        input { width: 100%; padding: 14px 50px 14px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #007bff; outline: none; }
        .paste-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; color: #666; padding: 10px; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .btn-check { background: #007bff; color: white; }
        .btn-check:hover { background: #0056b3; }
        .btn-dl-video { background: #10b981; color: white; display: none; } /* Hidden default */
        .btn-dl-audio { background: #f59e0b; color: white; display: none; } /* Hidden default */
        
        .preview-area { margin-bottom: 20px; display: none; animation: fadeIn 0.5s; }
        .preview-area img { width: 100%; border-radius: 10px; max-height: 250px; object-fit: cover; }
        .preview-title { font-size: 14px; margin-top: 10px; color: #555; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #007bff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .status { font-size: 13px; margin-top: 10px; color: #666; min-height: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2><i class="fab fa-tiktok"></i> / <i class="fab fa-facebook"></i> Downloader</h2>
    
    <div class="input-box">
        <input type="text" id="url" placeholder="Dán link TikTok hoặc Facebook vào đây...">
        <button class="paste-btn" onclick="pasteLink()"><i class="fas fa-paste"></i></button>
    </div>

    <div class="preview-area" id="preview">
        <img id="thumb" src="" alt="">
        <div class="preview-title" id="vidTitle"></div>
    </div>

    <button class="btn btn-check" id="checkBtn" onclick="fetchInfo()">
        <span class="btn-text">Lấy Link</span>
        <div class="loader" id="mainLoader"></div>
    </button>

    <button class="btn btn-dl-video" id="vidBtn" onclick="downloadVideo()">
        <i class="fas fa-video"></i> Tải Video (MP4)
    </button>

    <button class="btn btn-dl-audio" id="audBtn" onclick="downloadAudio()">
        <i class="fas fa-music"></i> Tải Audio (MP3)
    </button>

    <div class="status" id="statusMsg"></div>
</div>

<script>
    let currentUrl = '';

    async function pasteLink() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('url').value = text;
        } catch(e) {}
    }

    function setLoading(isLoading) {
        const loader = document.getElementById('mainLoader');
        const text = document.querySelector('.btn-check .btn-text');
        const checkBtn = document.getElementById('checkBtn');
        
        if(isLoading) {
            loader.style.display = 'block';
            text.style.display = 'none';
            checkBtn.disabled = true;
            document.getElementById('statusMsg').innerText = "Đang xử lý...";
        } else {
            loader.style.display = 'none';
            text.style.display = 'block';
            checkBtn.disabled = false;
        }
    }

    function resetUI() {
        document.getElementById('preview').style.display = 'none';
        document.getElementById('vidBtn').style.display = 'none';
        document.getElementById('audBtn').style.display = 'none';
        document.getElementById('statusMsg').innerText = "";
    }

    async function fetchInfo() {
        const url = document.getElementById('url').value.trim();
        if(!url) return;
        
        currentUrl = url;
        resetUI();
        setLoading(true);

        try {
            const res = await fetch('/api/info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            });
            
            const data = await res.json();
            
            if(res.ok) {
                document.getElementById('thumb').src = data.thumbnail;
                document.getElementById('vidTitle').innerText = data.title;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('vidBtn').style.display = 'flex';
                document.getElementById('audBtn').style.display = 'flex';
                document.getElementById('statusMsg').innerText = "Đã tìm thấy! Chọn định dạng để tải.";
            } else {
                document.getElementById('statusMsg').innerText = "Lỗi: " + data.error;
            }
        } catch(e) {
            document.getElementById('statusMsg').innerText = "Lỗi kết nối server.";
        } finally {
            setLoading(false);
        }
    }

    async function downloadVideo() {
        // Video tải bằng Direct Link -> Siêu nhanh
        const btn = document.getElementById('vidBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loader" style="display:block; border-color: white; border-top-color: transparent;"></div>';
        
        try {
            const res = await fetch('/api/get-video-link', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: currentUrl})
            });
            const data = await res.json();
            
            if(data.downloadUrl) {
                // Mở link trực tiếp để trình duyệt tự tải
                const a = document.createElement('a');
                a.href = data.downloadUrl;
                a.target = '_blank'; // Mở tab mới để tải (an toàn nhất)
                a.rel = 'noreferrer';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                document.getElementById('statusMsg').innerText = "Đang tải video...";
            } else {
                alert("Không lấy được link tải video.");
            }
        } catch(e) {
            alert("Lỗi khi lấy link tải.");
        }
        btn.innerHTML = originalText;
    }

    function downloadAudio() {
        // Audio phải qua xử lý server để convert MP3 chuẩn
        document.getElementById('statusMsg').innerText = "Đang convert sang MP3 (Chờ xíu)...";
        const dlUrl = `/api/stream-audio?url=${encodeURIComponent(currentUrl)}`;
        
        // Dùng iframe ẩn để trigger download mà không reload trang
        let hiddenIframe = document.getElementById('hiddenDownloader');
        if (!hiddenIframe) {
            hiddenIframe = document.createElement('iframe');
            hiddenIframe.id = 'hiddenDownloader';
            hiddenIframe.style.display = 'none';
            document.body.appendChild(hiddenIframe);
        }
        hiddenIframe.src = dlUrl;
    }
</script>

</body>
</html>
